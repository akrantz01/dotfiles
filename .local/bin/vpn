#!/usr/bin/env python3

from argparse import ArgumentParser
from dbus import SystemBus, Interface
from elevate import elevate
from os import geteuid
from sys import exit

# Instantiate the argument parser
parser = ArgumentParser(description="Manage the VPN")
parser.add_argument("-s", "--status", action="store_true")
args = parser.parse_args()

# Connect to the systemd d-Bus
sysbus = SystemBus()
systemd = sysbus.get_object("org.freedesktop.systemd1", "/org/freedesktop/systemd1")
manager = Interface(systemd, "org.freedesktop.systemd1.Manager")

# Load the wireugard unit
path = manager.LoadUnit("wg-quick@wg0.service")
wireguard = sysbus.get_object("org.freedesktop.systemd1", path)
unit = Interface(wireguard, "org.freedesktop.systemd1.Unit")
properties = Interface(wireguard, "org.freedesktop.DBus.Properties")

# Get the current status
status = properties.Get("org.freedesktop.systemd1.Unit", "ActiveState")
if args.status:
  print(f"VPN is {status}")
  exit(0)

# Check running as root
if geteuid() == 0:
  elevate(graphical=False)

# Start or stop the service based on the current status
{
  "active": unit.Stop,
  "inactive": unit.Start
}[status]("fail")
